version: 1
defaults:
  manifest_mode: remote # ALWAYS default remote
  verify_host: https://verify.survival.test
  manifest_host: https://manifests.survival.test
scenarios:
  - id: IMG_JPEG_Q75_STRIP
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["-strip", "-quality", "75"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "EXIF/IPTC removed; embedded JUMBF likely stripped"

  - id: IMG_RESIZE_1024
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["-resize", "1024x"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Resize transformation strips embedded claims"

  - id: IMG_CONVERT_WEBP
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["webp"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Format conversion removes JUMBF entirely"

  - id: IMG_CONVERT_AVIF
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["avif"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "AVIF conversion strips all metadata"

  - id: IMG_CROP_CENTER
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["-gravity", "center", "-crop", "50%x50%"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Crop operation breaks embedded claim integrity"

  - id: IMG_PROGRESSIVE_BASELINE
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["-interlace", "none"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Progressive to baseline conversion strips metadata"

  - id: IMG_METADATA_REWRITE
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["-set", "exif:Software", "TestOptimizer"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Metadata rewrite breaks embedded signatures"

  - id: IMG_ROTATE_90
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["-rotate", "90"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Rotation strips embedded claims due to pixel rearrangement"

  - id: IMG_WATERMARK_OVERLAY
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["-gravity", "southeast", "-pointsize", "24", "-fill", "white", "-undercolor", "black", "-annotate", "+10+10", "WATERMARK"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Watermark overlay destroys embedded provenance"

  - id: IMG_THUMBNAIL_150X150
    sandbox: strip-happy
    transforms:
      - tool: "magick"
        args: ["-thumbnail", "150x150"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Thumbnail generation strips all metadata and embedded claims"

  - id: CDN_RECOMPRESS_Q80
    sandbox: strip-happy
    transforms:
      - tool: "simulate-proxy"
        args: ["--recompress", "--quality", "80"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "CDN recompression strips embedded claims"

  - id: CDN_REWRITES_ETAG
    sandbox: strip-happy
    transforms:
      - tool: "simulate-proxy"
        args: ["--alter-etag", "--vary-ua"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "ETag mutation doesn't affect remote manifest resolution"

  - id: LINK_HEADER_DROPPED
    sandbox: strip-happy
    transforms:
      - tool: "simulate-proxy"
        args: ["--drop-link-header"]
    expected:
      remote_survives: true   # recovered by HTML <link> and JS preflight
      embed_survives: false
      notes: "Link header drop recovered by HTML fallback"

  - id: CACHE_POISON_ATTEMPT
    sandbox: strip-happy
    transforms:
      - tool: "simulate-proxy"
        args: ["--poison-cache", "--fake-manifest"]
    expected:
      remote_survives: false
      embed_survives: false
      notes: "Cache poisoning detected by hash alignment failure"

  - id: FILENAME_CHANGE
    sandbox: strip-happy
    transforms:
      - tool: "simulate-proxy"
        args: ["--rename-file", "optimized.jpg"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Filename change doesn't affect manifest resolution"

  - id: IMG_PRESERVE_EMBED_NOP
    sandbox: preserve-embed
    transforms:
      - tool: "copy"
        args: []
    expected:
      remote_survives: true
      embed_survives: true
      notes: "No transformation preserves both remote and embed"

  - id: IMG_PRESERVE_EMBED_RESIZE
    sandbox: preserve-embed
    transforms:
      - tool: "magick"
        args: ["-resize", "80%"]
    expected:
      remote_survives: true
      embed_survives: maybe # counted as degraded; advisory
      notes: "Resize may preserve some embedded data but degraded"

  - id: REMOTE_ONLY_BASELINE
    sandbox: remote-only
    transforms:
      - tool: "copy"
        args: []
    expected:
      remote_survives: true
      embed_survives: false
      notes: "Remote-only sandbox blocks embed extraction"

  - id: CSP_BLOCK_EMBED
    sandbox: remote-only
    transforms:
      - tool: "simulate-proxy"
        args: ["--add-csp", "default-src 'none'"]
    expected:
      remote_survives: true
      embed_survives: false
      notes: "CSP blocks embedded content extraction"
